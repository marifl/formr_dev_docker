# Basic server configuration
ServerAdmin admin@formr.local
ServerSignature Off
UseCanonicalName Off

# Global settings
ErrorDocument 403 /error/403/Forbidden
ErrorDocument 404 /error/404/NotFound
AddDefaultCharset UTF-8
AddType image/x-icon .ico
LogLevel info

# Logging
ErrorLog /dev/stderr
TransferLog /dev/stdout

# Enable rewrite and headers modules
RewriteEngine On
LoadModule headers_module modules/mod_headers.so

<VirtualHost *:80>
    ServerName formr.local
    ServerAlias localhost
    DocumentRoot /formr/formr/webroot

    XSendFile On
    XSendFilePath /formr/tmp/downloads

    # Comprehensive asset serving
    Alias /assets/ /formr/formr/webroot/assets/
    <Directory "/formr/formr/webroot/assets">
        Options -Indexes +FollowSymLinks
        Require all granted
        # Remove CORS headers
        Header unset Access-Control-Allow-Origin
    </Directory>

    <Directory "/formr/formr/webroot">
         Options +FollowSymLinks -MultiViews -Indexes
         AllowOverride All
         Require all granted
         
         # Remove CORS headers
         Header unset Access-Control-Allow-Origin
         Header unset Access-Control-Allow-Methods
         Header unset Access-Control-Allow-Headers
    </Directory>

    # Redirect HTTP to HTTPS for formr.local and localhost
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP_HOST} ^(formr\.local|localhost)$ [NC]
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Rewrite rules to ensure proper asset serving
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^(.*)$ - [L]

    # Fallback to index.php for dynamic content
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ /index.php [L,QSA]

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
